<script>
document.addEventListener("DOMContentLoaded", function() {
  
  // 1. Find the "active" book chapter in the sidebar
  // Quarto adds the 'active' class to the link of the current page.
  const activeSidebarLink = document.querySelector('.sidebar-item-container .active');
  
  if (!activeSidebarLink) return; // Exit if we can't find the active page in sidebar

  // 2. Find all headers in the main content (H2 and H3)
  const headers = document.querySelectorAll('main.content h2, main.content h3');
  
  if (headers.length === 0) return; // Exit if no headers

  // 3. Create the new TOC list container
  const tocList = document.createElement('ul');
  tocList.classList.add('custom-page-toc');
  
  // 4. Loop through headers and build list items
  headers.forEach(header => {
    // Ensure header has an ID (Quarto usually adds them, but safety first)
    if (!header.id) {
      header.id = header.innerText.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');
    }

    const li = document.createElement('li');
    li.classList.add(header.tagName.toLowerCase()); // Class 'h2' or 'h3' for styling
    
    const link = document.createElement('a');
    link.href = '#' + header.id;
    link.innerText = header.innerText;
    // Add a class for scroll-spy targeting later
    link.classList.add('page-toc-link');
    
    // Optional: Clean up "1.1" numbers if you don't want them in TOC
    // link.innerText = header.innerText.replace(/^[\d\.]+\s+/, ''); 

    li.appendChild(link);
    tocList.appendChild(li);
  });

  // 5. Append this new list INSIDE the active sidebar item
  // This makes it physically part of the active book chapter's block
  activeSidebarLink.parentNode.appendChild(tocList);

  // --- OPTIONAL: SCROLL SPY (Highlighter) ---
  // This highlights the TOC item as you scroll
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      const id = entry.target.getAttribute('id');
      const tocLink = tocList.querySelector(`a[href="#${id}"]`);
      if (entry.isIntersecting) {
        // Remove active from all
        tocList.querySelectorAll('a').forEach(a => a.classList.remove('active'));
        // Add to current
        if(tocLink) tocLink.classList.add('active');
      }
    });
  }, { rootMargin: '-100px 0px -66%' });

  headers.forEach(header => observer.observe(header));
});
</script>